<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="js/p5.js"></script>
  <script src="js/circuitboardgenerator.js"></script>

  <title>Cyber Func Online</title>

  <!-- HTML -->


  <!-- Custom Styles -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/default.css">
  <link rel="stylesheet" href="css/circuitboardgenerator.css">
  <link rel="stylesheet" href="https://lib.duckode.com/css/contextmenuutils.css">
</head>

<body>
  <app>
    <div class="sign-container">
      <div class="sign">
        <input class="account" type="text" placeholder="Email/Username..">
        <input class="password" type="password" placeholder="password..">
        <div class="sign-switch">
          <div class="sign-switcher">Register</div>
        </div>
        <div class="sign-action">Login</div>
        <div class="sign-google">
          <svg width="46" height="46" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <defs>
              <rect id="b" x="0" y="0" width="40" height="40" rx="2"></rect>
              <rect id="c" x="5" y="5" width="38" height="38" rx="1"></rect>
              <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="a">
                <feOffset dy="1" in="SourceAlpha" result="shadowOffsetOuter1"></feOffset>
                <feGaussianBlur stdDeviation="0.5" in="shadowOffsetOuter1" result="shadowBlurOuter1"></feGaussianBlur>
                <feColorMatrix values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.168 0" in="shadowBlurOuter1"
                  result="shadowMatrixOuter1"></feColorMatrix>
                <feOffset in="SourceAlpha" result="shadowOffsetOuter2"></feOffset>
                <feGaussianBlur stdDeviation="0.5" in="shadowOffsetOuter2" result="shadowBlurOuter2"></feGaussianBlur>
                <feColorMatrix values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.084 0" in="shadowBlurOuter2"
                  result="shadowMatrixOuter2"></feColorMatrix>
                <feMerge>
                  <feMergeNode in="shadowMatrixOuter1"></feMergeNode>
                  <feMergeNode in="shadowMatrixOuter2"></feMergeNode>
                  <feMergeNode in="SourceGraphic"></feMergeNode>
                </feMerge>
              </filter>
            </defs>
            <g fill="none" fill-rule="evenodd">
              <g transform="translate(3 3)" filter="url(#a)">
                <use fill="#4285F4" xlink:href="#b"></use>
                <use xlink:href="#b"></use>
                <use xlink:href="#b"></use>
                <use xlink:href="#b"></use>
              </g>
              <g transform="translate(-1 -1)">
                <use fill="#FFF" xlink:href="#c"></use>
                <use xlink:href="#c"></use>
                <use xlink:href="#c"></use>
                <use xlink:href="#c"></use>
              </g>
              <path
                d="M31.64 23.205c0-.639-.057-1.252-.164-1.841H23v3.481h4.844a4.14 4.14 0 01-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"
                fill="#4285F4"></path>
              <path
                d="M23 32c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711h-3.007v2.332A8.997 8.997 0 0023 32z"
                fill="#34A853"></path>
              <path
                d="M17.964 24.71a5.41 5.41 0 01-.282-1.71c0-.593.102-1.17.282-1.71v-2.332h-3.007A8.996 8.996 0 0014 23c0 1.452.348 2.827.957 4.042l3.007-2.332z"
                fill="#FBBC05"></path>
              <path
                d="M23 17.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C27.463 14.891 25.426 14 23 14a8.997 8.997 0 00-8.043 4.958l3.007 2.332c.708-2.127 2.692-3.71 5.036-3.71z"
                fill="#EA4335"></path>
              <path d="M14 14h18v18H14V14z"></path>
            </g>
          </svg>
          &emsp;Sign in with google
        </div>
      </div>
    </div>
    <div class="canvas">
      <div class="nav">
        <div class="nav-username">
          用戶名稱<br>
          <div class="en-set">
            USER NAME
          </div>
        </div>
        <div class="nav-wallet">
          <div class="nav-wallet-btc-data">
            0
          </div>
          &ensp;BTC&emsp;
          <div class="nav-wallet-etc-data">
            0
          </div>
          &ensp;ETC
        </div>
        <div class="nav-guide">
          嚮導 / GUIDELINES
        </div>
      </div>
      <div class="content">
        <div class="map" id="idrag-map">
          <div class="map-b">
            <div class="map-circle">
              ◯
            </div>
            <div class="map-me">
              ◭
            </div>
            <div class="map-enemies"></div>
            <div class="map-enemies"></div>
            <div class="map-enemies"></div>
            <div class="map-enemies"></div>
            <div class="map-enemies"></div>
            <div class="map-info">
              <div class="map-info-border">
                <div class="map-info-avt"></div>
                <div class="map-info-title">MS-NAME</div>
              </div>
            </div>
            <div class="gameover">
              <div class="gameover-border">
                GAMEOVER
              </div>
              <div class="gameover-info">
                GAME INFO
              </div>
            </div>
          </div>
        </div>
        <div class="battle" id="idrag-battle">
          <div class="battle-top-block"></div>
          <div class="battle-bg"></div>
          <div class="battle-exit">&#60;&#45; 逃跑</div>
          <div class="container">
            <div class="enemy-hp">
              <div class="enemy-ui-hp-base">
              </div>
              <div class="enemy-ui-hp">
              </div>
            </div>
            <div class="battle-enemy">
            </div>
            <div class="reroll">
              <input type="range" min="0" max="10" step="any" value="0">
              <div>
                &#45;&#62; 拆除晶片
              </div>
            </div>
            <div class="battle-me-boxes">
              <div class="battle-me-box">
                <div class="player-dmg en-set">
                  0%
                </div>
                頭盔
                <div class="en-set">
                  HELMET
                </div>
                <div class="battle-helmet">
                  N/A
                </div>
              </div>
              <div class="battle-me-box">
                <div class="player-dmg en-set">
                  0%
                </div>
                上衣
                <div class="en-set">
                  JACKET
                </div>
                <div class="battle-jacket">
                  N/A
                </div>
              </div>
              <div class="battle-me-box">
                <div class="player-dmg en-set">
                  0%
                </div>
                左手
                <div class="en-set">
                  LEFT WEAPON
                </div>
                <div class="battle-weapon-l">
                  N/A
                </div>
              </div>
              <div class="battle-me-box">
                <div class="player-dmg en-set">
                  0%
                </div>
                右手
                <div class="en-set">
                  RIGHT WEAPON
                </div>
                <div class="battle-weapon-r">
                  N/A
                </div>
              </div>
              <div class="battle-me-box">
                <div class="player-dmg en-set">
                  0%
                </div>
                腿掛
                <div class="en-set">
                  LEGSTRAP
                </div>
                <div class="battle-legstrap">
                  N/A
                </div>
              </div>
              <div class="battle-me-box">
                <div class="player-dmg en-set">
                  0%
                </div>
                靴子
                <div class="en-set">
                  BOOTS
                </div>
                <div class="battle-boots">
                  N/A
                </div>
              </div>
            </div>
            <div class="roll-container">
              <div class="roll">載入晶片 X 2</div>
            </div>
          </div>
        </div>
        <div class="item">
          <div class="item-all-btn">
            <div>
              裝備<br>
              <div class="en-set">
                EQUIP
              </div>
            </div>
          </div>
          <div class="item-all-btn">
            <div>
              物品百科<br>
              <div class="en-set">
                ITEMS ENCYCLOPEDIA
              </div>
            </div>
          </div>
          <div class="item-all-btn">
            <div>
              商城<br>
              <div class="en-set">
                MALL
              </div>
            </div>
          </div>
          <div class="item-all-btn">
            <div>
              販賣機<br>
              <div class="en-set">
                VENDING MACHINE
              </div>
            </div>
          </div>
          <div class="equip">
            <div class="en-set color-0">
              頭盔
              HELMET
            </div>
            <div class="en-set color-0">
              上衣
              JACKET
            </div>
            <div class="en-set color-0">
              左手
              LEFT WEAPON
            </div>
            <div class="en-set color-0">
              右手
              RIGHT WEAPON
            </div>
            <div class="en-set color-0">
              腿掛
              LEGSTRAP
            </div>
            <div class="en-set color-0">
              靴子
              BOOTS
            </div>
          </div>
          <div class="encyclopedia">
            <div class="item-all-btn">
              <div>
                頭盔<br>
                <div class="en-set">
                  HELMET
                </div>
              </div>
            </div>
            <div class="item-all-btn">
              <div>
                上衣<br>
                <div class="en-set">
                  JACKET
                </div>
              </div>
            </div>
            <div class="item-all-btn">
              <div>
                武器<br>
                <div class="en-set">
                  WEAPON
                </div>
              </div>
            </div>
            <div class="item-all-btn">
              <div>
                腿掛<br>
                <div class="en-set">
                  LEG STRAP
                </div>
              </div>
            </div>
            <div class="item-all-btn">
              <div>
                靴子<br>
                <div class="en-set">
                  BOOTS
                </div>
              </div>
            </div>
            <div class="back-btn">
              &#60;&#45;
            </div>
          </div>

          <div class="e-helmet">
            <div class="item-all-btn">
              <div>
                初級普通頭盔<br>
                <div class="en-set">
                  BASIC STANDARD HELMET
                </div>
              </div>
            </div>
            <div class="item-all-btn">
              <div>
                克羅爾ㄧ型鋼盔<br>
                <div class="en-set">
                  KROLL TYPE I STEEL HELMET
                </div>
              </div>
            </div>
            <div class="back-btn">
              &#60;&#45;
            </div>
          </div>

          <div class="e-jacket">
            <div class="item-all-btn">
              <div>
                初級普通戰甲<br>
                <div class="en-set">
                  BASIC STANDARD ARMOR
                </div>
              </div>
            </div>

            <div class="back-btn">
              &#60;&#45;
            </div>
          </div>

          <div class="e-weapon">
            <div class="item-all-btn">
              <div>
                方圓十字盾<br>
                <div class="en-set">
                  SQUARE AND ROUND CROSS SHIELD
                </div>
              </div>
            </div>
            <div class="item-all-btn">
              <div>
                輕便水果刀<br>
                <div class="en-set">
                  LIGHTWEIGHT PARING KNIFE
                </div>
              </div>
            </div>
            <div class="item-all-btn">
              <div>
                中式文武菜刀<br>
                <div class="en-set">
                  CHINESE STYLE CHEF’S KNIFE
                </div>
              </div>
            </div>
            <div class="item-all-btn">
              <div>
                低伏電擊棒<br>
                <div class="en-set">
                  LOW-VOLTAGE STUN BATON
                </div>
              </div>
            </div>
            <div class="item-all-btn">
              <div>
                輕便手榴彈<br>
                <div class="en-set">
                  LIGHTWEIGHT GRENADE
                </div>
              </div>
            </div>

            <div class="back-btn">
              &#60;&#45;
            </div>
          </div>

          <div class="e-legstrap">
            <div class="item-all-btn">
              <div>
                補損口服藥<br>
                <div class="en-set">
                  ORAL RESTORATIVE MEDICATION
                </div>
              </div>
            </div>
            <div class="item-all-btn">
              <div>
                止損帶<br>
                <div class="en-set">
                  STOP-LOSS BELT
                </div>
              </div>
            </div>

            <div class="back-btn">
              &#60;&#45;
            </div>
          </div>

          <div class="e-boots">
            <div class="item-all-btn">
              <div>
                初級普通戰靴<br>
                <div class="en-set">
                  BASIC STANDARD COMBAT BOOTS
                </div>
              </div>
            </div>

            <div class="back-btn">
              &#60;&#45;
            </div>
          </div>

          <div class="e-info">
            <div class="e-info-top">
              <div class="e-info-img"></div>
              <div class="e-info-type"></div>
            </div>
            <div class="back-btn e-info-back">
              &#60;&#45;
            </div>
          </div>

        </div>
        <div class="stat">
          <img src="/img/human.png" alt="" class="content-stat" draggable="false">
          <div class="s-helmet"></div>
          <div class="s-jacket"></div>
          <div class="s-weapon-r"></div>
          <div class="s-weapon-l"></div>
          <div class="s-legstrap"></div>
          <div class="s-boots"></div>
        </div>
        <div class="lobby">
          <div id="messages"></div>
          <div class="type-in">
            <input id="message" placeholder="輸入訊息.." autocomplete="off">
            <button id="submit">傳送</button>
          </div>
        </div>
        <div class="settings">
          <div class="settings-username">
            <div>代號</div>
            <input type="text">
            <div class="username-update">✓</div>
          </div>
          <div class="logout">
            登出
            <div class="en-set">
              LOGOUT
            </div>
          </div>
        </div>
        <!--content end-->
      </div>

      <div class="footer-container">
        <div class="footer">
          <div class="menu-btn">
            <div>
              地圖<br>
              <div class="en-set">
                MAP
              </div>
            </div>
          </div>
          <div class="menu-btn">
            <div>
              物品<br>
              <div class="en-set">
                ITEM
              </div>
            </div>
          </div>
          <div class="menu-btn">
            <div>
              狀態<br>
              <div class="en-set">
                STATE
              </div>
            </div>
          </div>
          <div class="menu-btn">
            <div>
              大廳<br>
              <div class="en-set">
                LOBBY
              </div>
            </div>
          </div>
          <div class="menu-btn">
            <div>
              設定<br>
              <div class="en-set">
                SETTINGS
              </div>
            </div>
          </div>

          <div class="lobby-hint"><div></div></div>
        </div>
      </div>

    </div>
  </app>
  <script src="https://lib.duckode.com/js/storageutils.min.js"></script>
  <script src="https://lib.duckode.com/js/contextmenuutils.min.js"></script>
  <!-- Project -->
  <script src="main.js"></script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, query, limitToLast, push, onChildAdded, onChildRemoved, set, child, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD1HnXKHrNIsSGJo7KaooVtZYbowuHR8uo",
      authDomain: "source-c3817.firebaseapp.com",
      databaseURL: "https://source-c3817-default-rtdb.firebaseio.com",
      projectId: "source-c3817",
      storageBucket: "source-c3817.appspot.com",
      messagingSenderId: "262948457201",
      appId: "1:262948457201:web:bae1b685432d4bed84b750"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getDatabase();

    // data
    let userID = null;
    let username = null;

    // ref
    const lobbyRef = ref(db, 'lobby');
    const limitlobbyRef = query(lobbyRef, limitToLast(10));

    // element
    const sign_container = document.querySelector('.sign-container');
    const account = document.querySelector('.account');
    const password = document.querySelector('.password');
    const sign_switcher = document.querySelector('.sign-switcher');
    const sign_action = document.querySelector('.sign-action');
    const sign_google = document.querySelector('.sign-google');
    const canvas = document.querySelector('.canvas');
    const lobby = document.querySelector('.lobby');
    const messages = document.getElementById("messages");
    const message = document.getElementById("message");
    const submit = document.getElementById("submit");
    const logout = document.querySelector('.logout');
    const username_update = document.querySelector('.username-update');
    const settings_username_input = document.querySelector('.settings-username input[type=text]');
    const nav_username = document.querySelector('.nav-username');

    // var
    let sign_status = false;

    // set language
    auth.useDeviceLanguage();

    // google auth
    const userSignInGoogle = async () => {
      signInWithPopup(auth, provider)
        .then((result) => {
          // This gives you a Google Access Token. You can use it to access the Google API.
          const credential = GoogleAuthProvider.credentialFromResult(result);
          const token = credential.accessToken;
          // The signed-in user info.
          const user = result.user;
          // IdP data available using getAdditionalUserInfo(result)
          // ...
        }).catch((error) => {
          // Handle Errors here.
          const errorCode = error.code;
          const errorMessage = error.message;
          // The email of the user's account used.
          const email = error.customData.email;
          // The AuthCredential type that was used.
          const credential = GoogleAuthProvider.credentialFromError(error);
          // ...
        });
    }

    // event
    sign_google.addEventListener("click", userSignInGoogle);
    sign_action.addEventListener("click", () => {
      sign_status ? createUser() : signIn();
    });
    sign_switcher.addEventListener("click", () => {
      if (!sign_status) {
        sign_switcher.textContent = 'Login';
        sign_action.textContent = 'Create';
        sign_status = true;
      } else {
        sign_switcher.textContent = 'Register';
        sign_action.textContent = 'Login';
        sign_status = false;
      }
    });
    message.addEventListener("focus", () => {
      message.setAttribute('placeholder', '輸入訊息..');
      message.style.setProperty('--message-placeholder-color', '');
      message.style.setProperty('--message-placeholder-opacity', '0.5');
    });
    submit.addEventListener("click", () => {
      sendMessage();
    });
    document.body.addEventListener("keyup", (e) => {
      if (e.key === "Enter") {
        if (document.querySelector('.sign-action')) {
          sign_status ? createUser() : signIn();
        } else if (lobby.style.display === 'flex') {
          sendMessage();
        }
      }
    });
    settings_username_input.addEventListener("input", () => {
      if (auth.currentUser.displayName !== settings_username_input.value) {
        username_update.style.display = 'flex';
      } else {
        username_update.style.display = '';
      }
    });
    username_update.addEventListener("click", () => {
      UpdateProfile(settings_username_input.value);
      username_update.style.display = '';
    });
    logout.addEventListener("click", () => {
      signOutUser();
    });

    // check if login
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in, see docs for a list of available properties
        // https://firebase.google.com/docs/reference/js/auth.user
        const uid = user.uid;

        userID = uid;
        username = user.displayName;

        sign_container.remove();
        updateMessage();
        canvas.style.display = 'block';

        settings_username_input.value = user.displayName;
        nav_username.innerHTML = `${user.displayName}<br><div class="en-set">USER NAME</div>`;

        console.log(user);
      } else {
        // User is signed out
      }
    });

    // use login function
    function signIn() {
      signInWithEmailAndPassword(auth, account.value, password.value)
        .then((userCredential) => {
          const user = userCredential.user;
        })
        .catch((error) => {
          const errorCode = error.code;
          const errorMessage = error.message;
          console.log(errorCode);
        });
    }
    function createUser() {
      createUserWithEmailAndPassword(auth, account.value, password.value)
        .then((userCredential) => {
          UpdateProfile(auth.currentUser.email.replace(/@.*?(?=@|$)/g, ''));
          signOutUser();
        })
        .catch((error) => {
          const errorCode = error.code;
          const errorMessage = error.message;
          console.log(errorCode);
        });
    }
    function signOutUser() {
      signOut(auth).then(() => {
        location.reload();
      }).catch((error) => {
        console.log(error);
      });
    }
    function UpdateProfile(displayName) {
      updateProfile(auth.currentUser, {
        displayName: displayName
      }).then(() => {
        // Profile updated!
        username = auth.currentUser.displayName;
        settings_username_input.value = auth.currentUser.displayName;
        nav_username.innerHTML = `${auth.currentUser.displayName}<br><div class="en-set">USER NAME</div>`;
        console.log('Profile updated!');
        // ...
      }).catch((error) => {
        // An error occurred
        // ...
        console.log(error);
      });
    }

    // use message function
    function updateMessage() {
      // Listen on child List
      onChildAdded(limitlobbyRef, (snapshot) => {
        const data = snapshot.val();
        if (lobby.style.display !== 'flex') {
          document.querySelector('.lobby-hint').style.display = 'flex';
        }

        if (data.uid !== userID) {
          messages.innerHTML += `
          <div id='${snapshot.key}'>
            <div class="msg-id">${data.who}</div>
            <div class="msg-row">
              <div class="msg-msg">${data.message}</div>
              <div class="msg-report">⚠︎</div>
            </div>
            <div class="msg-time">${ToAMPMYMD(data.time)}</div>
          </div>`;
        } else {
          messages.innerHTML += `
          <div id='${snapshot.key}'>
            <div class="msg-id">*${data.who}</div>
            <div class="msg-row">
              <div class="msg-msg">${data.message}</div>
              <div class="msg-del">␐</div>
            </div>
            <div class="msg-time">${ToAMPMYMD(data.time)}</div>
          </div>`;
        }
        document.querySelectorAll(".msg-del").forEach(element => {
          element.addEventListener("click", () => {
            remove(child(lobbyRef, element.parentElement.parentElement.id));
          });
        });
      });
      onChildRemoved(limitlobbyRef, (snapshot) => {
        document.getElementById(snapshot.key).innerHTML = '>>> SYSTEM DELETE';
        setTimeout(() => {
          document.getElementById(snapshot.key).remove();
        }, 1000);
      });
    }
    function setMessageData() {
      set(push(lobbyRef), {
        time: Date.now(),
        uid: userID,
        who: username,
        message: message.value
      });
      message.value = '';
    }
    function sendMessage() {
      message.blur();
      checkMessage(document.getElementById("message")).then(valid => {
        if (valid) {
          setMessageData();
          lobby.scrollTo({
            top: lobby.scrollHeight,
            behavior: 'smooth'
          });
        }
      }).catch(error => {
        message.value = '';
        message.style.setProperty('--message-placeholder-opacity', '1');
        console.log(error);
        message.setAttribute('placeholder', error);
      });
    }
    function checkMessage(input) {
      return new Promise((resolve, reject) => {
        if (userID === null) {
          reject('[⚠︎] please login account');
          message.style.setProperty('--message-placeholder-color', '#f7d967');
        } else if (/^\s+$/.test(input.value)) {
          reject('[error] cannot consist solely of spaces');
          message.style.setProperty('--message-placeholder-color', '#f00');
        } else if (input.value.trim() === "") {
          reject('[error] cannot be blank');
          message.style.setProperty('--message-placeholder-color', '#f00');
        } else {
          resolve(true);
        }
      });
    }

    // use other function
    function ToAMPM(timestamp) {
      const date = new Date(timestamp);
      let hours = date.getHours();
      let minutes = date.getMinutes();
      const period = hours >= 12 ? '下午' : '上午';
      hours = hours % 12;
      hours = hours ? hours : 12;
      minutes = minutes < 10 ? '0' + minutes : minutes;
      return `${period} ${hours}:${minutes}`;
    }
    function ToAMPMYMD(timestamp) {
      const date = new Date(timestamp);

      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      let hours = date.getHours();
      let minutes = date.getMinutes();
      const period = hours >= 12 ? hours < 13 ? '中午' : hours < 16 ? '下午' : hours < 18 ? '傍晚' : '晚上' : hours < 5 ? '凌晨' : hours < 8 ? '清晨' : '上午';

      hours = hours % 12;
      hours = hours ? hours : 12;

      minutes = minutes < 10 ? '0' + minutes : minutes;

      return `${month}/${day}/${hours}:${minutes}${period}`;
    }
  </script>
</body>

</html>